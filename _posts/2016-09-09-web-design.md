---
layout: post
title:  "SOA and micro service"
date:   "2016-09-08 00:00:00"
categories: web
keywords: java, spring, web
---

## 单一架构和 SOA

企业级的应用一般都会面临各种各样的业务需求，而常见的方式是把大量功能堆积到同一个单体架构中去。单体架构的初期效率很高，
应用会随着时间推移逐渐变大。在每次的迭代中，开发团队都会面对新功能，然后开发许多新代码，随着时间推移，这个简单
的应用会变成了一个巨大的怪物。

## SOA (service oriented architecture) 
                                               
大部分企业通过SOA来解决上述问题，SOA的思路是把应用中相近的功能聚合到一起，以服务的形式提供出去。
因此基于SOA架构的应用可以理解为一批服务的组合。SOA带来的问题是，引入了大量的服务、消息格式定义和规范。

多数情况下，SOA的服务直接相互独立，但是部署在**同一个运行环境中**（类似于一个Tomcat实例下，运行了很多web应用）。和单
体架构类似，随着业务功能的增多SOA的服务会变得越来越复杂，本质上看没有因为使用SOA而变的更好。图1，是一个包
含多种服务的在线零售网站，所有的服务部署在一个运行环境中，是一个典型的单体架构。

单体架构的应用一般有以下特点：

* 设计、开发、部署为一个单独的单元。
* 会变得越来越复杂，最后导致维护、升级、新增功能变得异常困难
* 很难以敏捷研发模式进行开发和发布
* 部分更新，都需要重新部署整个应用
* 水平扩展：必须以应用为单位进行扩展，在资源需求有冲突时扩展变得比较困难（部分服务需要更多的计算资源，部分需要更多内存资源）
* 可用性：一个服务的不稳定会导致整个应用出问题
* 创新困难：很难引入新的技术和框架，所有的功能都构建在同质的框架之上

## Micro Service

微服务架构的核心思想是，一个应用是由多个小的、相互独立的、微服务组成，这些服务运行在自己的进程中，开发和发布都没有依赖。

![](/images/posts/web/server-basic-tech-stack.png)

### 通信

SOA 使用 企业服务总线, 他负责服务注册, 调用, 路由, 时间框架

Miscro service 点对点方式 – 直接调用服务, 问题在于微服务多了以后, 知道对方的信
息变得非常的麻烦, 管理微服务之间的通信很困难

### 同步消息

REST, thrift

同步消息就是客户端需要保持等待，直到服务器返回应答。REST是微服务中默认的同步消息方式，它提供了基于HTTP协议和资源API风格的简单消息格式，多数微服务都采用这种方式（每个功能代表了一个资源和对应的操作）。

Thrift是另外一个可选的方案。它采用接口描述语言定义并创建服务，支持可扩展的跨语言服务开发，所包含的代码生成引擎可以在多种语言中，如 C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, Smalltalk 等创建高效的、无缝的服务，其传输数据采用二进制格式，相对 XML 和 JSON 体积更小，对于高并发、大数据量和多语言的环境更有优势。

### 分布式配置管理

当服务多起来, 每个服务的实例多起来以后, 每次修改服务的配置文件变得非常麻烦, 如果一个服务有 3 个实例,
就得修改三遍配置文件, 一个更好的办法是把每个服务的配置文件通过一个 Service 管理起来, 只要修改 config-server
的配置文件, 就能对这个 service 的所有实例生效

### 服务注册与发现

service 之间的通信往往使用 RESTful API, 但是这种 restful api 需要事先知道每个 service 节点的 IP 地址,
而这些 Service 的 IP 地址很难管理, 它们可能会变, 可能不止一个, 这时候更好的办法是通过类似于 DNS 的机制, 
通过一个 Service 的 name 发起对服务的调用, 这个过程就需要 Service registry and discovery 

Etcd – 高可用、分布式、一致性的键值存储，用于共享配置和服务发现。
Consul – 发现和配置的服务，提供 API 实现客户端注册和发现服务。
Apache ZooKeeper – 被分布式应用广泛使用的高性能协调服务。

### 断路器

为了整个系统的可用性, 当一个 service 出了问题以后不要拖垮整个系统, 这时候就需要一种保护机制, 而断路器做的事就是
当一个 service 对另一个疯狂 service 调用时, 断路器可以保护被调用的 service 不会被拖垮

### API gateway

API gateway 提供路由, 负载均衡, API 访问权限控制, 安全等功能, 负责系统外界之间的交互, 因为往往内在的服务都受防火墙, 没有其他安全机制的。

但是当系统做的越来越大时, API gateway 可能成为系统的瓶颈, 这时候可能就需要把安全机制放到每一个业务应用中, 让业务应用
直接对接统一认证中心, 同时使用缓存认证结果的方式避免对统一认证中心产生过大的压力

## Restful API
在别的 blog 有写过

## 统一调度中心

在很多业务中，定时调度是一个非常普遍的场景，比如定时去抓取数据、定时刷新订单的状态等。
通常的做法就是针对各自的业务依赖Linux的cron机制或者java中的quartz。统一调度中心则是对所有的调度任务进行管理，
这样能够统一对调度集群进行调优、扩展、任务管理等。azkaban和oozie是hadoop的流式工作管理引擎，
也可以作为统一调度中心来使用。当然，你也可以使用cron或者quartz来实现自己的统一调度中心。

```
根据cron表达式调度任务
动态修改、停止、删除任务
支持任务工作流：比如一个任务完成之后再执行下一个任务
任务支持脚本、代码、url等多种形式
任务执行的日志记录、故障报警
```


Rundeck


**HEAD** 检查一个对象是否存在
## 参考资料

[谈谈互联网后端基础设施](http://www.rowkey.me/blog/2016/08/27/server-basic-tech-stack/)

[撰写安全合格的REST API]()